
package Create{

my $FILE_ACCESS_MASK = {
  FILE_READ_DATA => 0x00000001,
  FILE_WRITE_DATA => 0x00000002,
  FILE_APPEND_DATA => 0x00000004,
  FILE_READ_EA => 0x00000008,
  FILE_WRITE_EA => 0x00000010,
  FILE_DELETE_CHILD => 0x00000040,
  FILE_EXECUTE => 0x00000020,
  FILE_READ_ATTRIBUTES => 0x00000080,
  FILE_WRITE_ATTRIBUTES => 0x00000100,
  DELETE => 0x00010000,
  READ_CONTROL => 0x00020000,
  WRITE_DAC => 0x00040000,
  WRITE_OWNER => 0x00080000,
  SYNCHRONIZE => 0x00100000,
  ACCESS_SYSTEM_SECURITY => 0x01000000,
  MAXIMUM_ALLOWED => 0x02000000,
  GENERIC_ALL => 0x10000000,
  GENERIC_EXECUTE => 0x20000000,
  GENERIC_WRITE => 0x40000000,
  GENERIC_READ => 0x80000000,
};

my $DIR_ACCESS_MASK = {
  FILE_LIST_DIRECTORY => 0x00000001,
  FILE_ADD_FILE => 0x00000002,
  FILE_ADD_SUBDIRECTORY => 0x00000004,
  FILE_READ_EA => 0x00000008,
  FILE_WRITE_EA => 0x00000010,
  FILE_TRAVERSE => 0x00000020,
  FILE_DELETE_CHILD => 0x00000040,
  FILE_READ_ATTRIBUTES => 0x00000080,
  FILE_WRITE_ATTRIBUTES => 0x00000100,
  DELETE => 0x00010000,
  READ_CONTROL => 0x00020000,
  WRITE_DAC => 0x00040000,
  WRITE_OWNER => 0x00080000,
  SYNCHRONIZE => 0x00100000,
  ACCESS_SYSTEM_SECURITY => 0x01000000,
  MAXIMUM_ALLOWED => 0x02000000,
  GENERIC_ALL => 0x10000000,
  GENERIC_EXECUTE => 0x20000000,
  GENERIC_WRITE => 0x40000000,
  GENERIC_READ => 0x80000000,
};
my $FILE_ATTRIBUTE = {
  FILE_ATTRIBUTE_ARCHIVE => 0x00000020,
  FILE_ATTRIBUTE_COMPRESSED => 0x00000800,
  FILE_ATTRIBUTE_DIRECTORY => 0x00000010,
  FILE_ATTRIBUTE_ENCRYPTED => 0x00004000,
  FILE_ATTRIBUTE_HIDDEN => 0x00000002,
  FILE_ATTRIBUTE_NORMAL => 0x00000080,
  FILE_ATTRIBUTE_NOT_CONTENT_INDEXED => 0x00002000,
  FILE_ATTRIBUTE_OFFLINE => 0x00001000,
  FILE_ATTRIBUTE_READONLY => 0x00000001,
  FILE_ATTRIBUTE_REPARSE_POINT => 0x00000400,
  FILE_ATTRIBUTE_SPARSE_FILE => 0x00000200,
  FILE_ATTRIBUTE_SYSTEM => 0x00000004,
  FILE_ATTRIBUTE_TEMPORARY => 0x00000100,
  FILE_ATTRIBUTE_INTEGRITY_STREAM => 0x00008000,
  FILE_ATTRIBUTE_NO_SCRUB_DATA => 0x00020000,
};
my $SHARE_ACCESS = {
  FILE_SHARE_READ => 0x00000001,
  FILE_SHARE_WRITE => 0x00000002,
  FILE_SHARE_DELETE => 0x00000004,
};
my $CREATE_DISPOSITION = {
  FILE_SUPERSEDE => 0x00000000,
  FILE_OPEN => 0x00000001,
  FILE_CREATE => 0x00000002,
  FILE_OPEN_IF => 0x00000003,
  FILE_OVERWRITE => 0x00000004,
  FILE_OVERWRITE_IF => 0x00000005,
};
my $CREATE_OPTIONS = {
  FILE_DIRECTORY_FILE => 0x00000001,
  FILE_WRITE_THROUGH => 0x00000002,
  FILE_SEQUENTIAL_ONLY => 0x00000004,
  FILE_NO_INTERMEDIATE_BUFFERING => 0x00000008,
  FILE_SYNCHRONOUS_IO_ALERT => 0x00000010,
  FILE_SYNCHRONOUS_IO_NONALERT => 0x00000020,
  FILE_NON_DIRECTORY_FILE => 0x00000040,
  FILE_COMPLETE_IF_OPLOCKED => 0x00000100,
  FILE_NO_EA_KNOWLEDGE => 0x00000200,
  FILE_RANDOM_ACCESS => 0x00000800,
  FILE_DELETE_ON_CLOSE => 0x00001000,
  FILE_OPEN_BY_FILE_ID => 0x00002000,
  FILE_OPEN_FOR_BACKUP_INTENT => 0x00004000,
  FILE_NO_COMPRESSION => 0x00008000,
  FILE_OPEN_REMOTE_INSTANCE => 0x00000400,
  FILE_OPEN_REQUIRING_OPLOCK => 0x00010000,
  FILE_DISALLOW_EXCLUSIVE => 0x00020000,
  FILE_RESERVE_OPFILTER => 0x00100000,
  FILE_OPEN_REPARSE_POINT => 0x00200000,
  FILE_OPEN_NO_RECALL => 0x00400000,
  FILE_OPEN_FOR_FREE_SPACE_QUERY => 0x00800000,
};
my $create_packer = [
  "16le" => 57,		#struct size
  "8le" => 0,		#SecurityFlags
  "8le" => 0,		#RequestedOplockLevel: no oplock: 0x00 
  "32le" => 2,          #ImpersonationLevel Impersonation:0x02
  "64le" => 0,          #SmbCreateFlags
  "64le" => 0,          #Reserved
  "32le" => 0x81,       #DesiredAccess list/read attribute: 0x81
  "32le" => 0x10,       #FileAttributes this file is a dir
  "32le" => 0x03,       #ShareAccess R/W
  "32le" => 0x01,	#CreateDisposition open file or fail
  "32le" => 0,		#CreateOptions
  "16le" => 64+57-1,	#NameOffset
  "16le" => 0,		#NameLength
  "32le" => 64+57-1,	#CreateContextsOffset
  "32le" => 0,		#CreateContextsLength
  "str" => "\x00",    	#buf
];


sub cmd_num{ return 0x0005 }

sub request{
  return Struct->packer($create_packer);
}

my $create_parser = [
  structSize => "16le",
  oplockLevel => "8le",
  flags => "8le",
  createAction => "32le",
  creationTime => "64le",
  lastAccessTime => "64le",
  lastWriteTime => "64le",
  changeTime => "64le",
  allocationSize => "64le",
  endofFile => "64le",
  fileAttributes => "32le",
  reserved2 => "32le",
  fileId => [16],
  createContextsOffset => "32le",
  createContextsLength => "32le",
  data => ["*"],
];

sub response{
  my ($class, $data) = @_;
  my $create_res = Struct->parser($create_parser, $data);
  return $create_res;
}
}
1;

