#!/usr/bin/perl -W
use strict;
use LWP::UserAgent;

my $rhost = "10.0.0.13";
my $login = "http://$rhost/moodle/login/index.php";
my $service = "http://$rhost/moodle/lib/ajax/service.php?sesskey=";

my $ua = LWP::UserAgent->new;
$ua->cookie_jar({});
$ua->proxy(["http", "https"], "http://127.0.0.1:8080");
$ua->requests_redirectable(["POST", "GET"]);

my $res = $ua->get($login);                                     #get logintoken, same for both normal/guest login
#print $res->headers->as_string;
#print $res->content;
print $ua->cookie_jar->as_string;

#print $res->content;

my $logintoken = $res->content =~ /name="logintoken" value="(\w{32})"/? $1 : die("no logintoken??");
print"logintoken: $logintoken\n";

my $loginForm = {
  logintoken=>$logintoken,
  username=>"guest",                                            #only guest and admin can list??
  password=>"guest",
};

$res = $ua->post($login, Content=>$loginForm);                  #actual login and get sesskey
#print $res->headers->as_string;
#print $res->content;

my $sesskey = $res->content =~ /"sesskey":"(\w{10})"/? $1 : die("no sesskey??");
print"sesskey: $sesskey\n";

for(1..6){
  my $json = '[{"index":0,"methodname":"core_message_data_for_messagearea_get_profile","args":{"currentuserid":1,"otheruserid":' . $_ . '}}]';
  my $res = $ua->post("$service$sesskey", "content-type"=>"application/json", Content=>$json);
  printf"%s\n", $res->content;
}

=pod
one of the methods in mysql -uroot -D moodle -e 'select name,classname,methodname from mdl_external_functions;'
works with guest user
POST /moodle/lib/ajax/service.php?sesskey=ymfrCFHceo HTTP/1.1

[{"index":0,"methodname":"core_message_data_for_messagearea_get_profile","args":{"currentuserid":1,"otheruserid":2}}]

[{"error":false,"data":{"userid":2,"email":"admin@local.com","country":"","city":"",
"fullname":"Admin User","profileimageurl":"http:\/\/10.0.0.13\/moodle\/theme\/image.php\/boost\/core\/1585767192\/u\/f1",
"profileimageurlsmall":"http:\/\/10.0.0.13\/moodle\/theme\/image.php\/boost\/core\/1585767192\/u\/f2",
"showonlinestatus":true,"isonline":false,"isblocked":false,"iscontact":false}}]

intersting services, login as guest
POST /moodle/lib/ajax/service.php?sesskey=5FPD9pZ7d9 HTTP/1.1
#request password reset
[{"index":0,"methodname":"core_auth_request_password_reset","args":{"email":"student@local.com"}}]
[{"index":0,"methodname":"core_auth_request_password_reset","args":{"username":"admin"}}]

#for initial email registration
[{"index":0,"methodname":"core_auth_resend_confirmation_email","args":{"username":"manager","password":"Pass1234!"}}]

[{"index":0,"methodname":"core_calendar_get_calendar_monthly_view","args":{"year":2020,"month":1, "courseid":1,"categoryid":1,"includenavigation":false,">
[{"index":0,"methodname":"core_calendar_get_calendar_day_view","args":{"year":2020,"month":1, "day":10,"courseid":1,"categoryid":1}}]
[{"index":0,"methodname":"core_calendar_get_calendar_upcoming_view","args":{"courseid":1,"categoryid":1}}]
=cut
